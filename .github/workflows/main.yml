permissions:
  contents: write
  pull-requests: write

name: Build LaTeX document
on: [push]
jobs:
  build_nix:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
      - name: Build with Nix
        run: nix build

  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
      - name: Compile English version
        uses: xu-cheng/latex-action@v4
        with:
          root_file: resume.tex
          args: -pdf -lualatex -interaction=nonstopmode -jobname=resume-en
      - name: Compile Italian version
        uses: xu-cheng/latex-action@v4
        with:
          root_file: resume.tex
          args: -pdf -lualatex -interaction=nonstopmode -jobname=resume-it
      - name: Compile French version
        uses: xu-cheng/latex-action@v4
        with:
          root_file: resume.tex
          args: -pdf -lualatex -interaction=nonstopmode -jobname=resume-fr
      - name: Check if .tex files changed
        id: check_tex_changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q '\.tex$'; then
            echo "tex_changed=true" >> $GITHUB_OUTPUT
          else
            echo "tex_changed=false" >> $GITHUB_OUTPUT
          fi
      - name: Generate screenshot from English PDF
        if: steps.check_tex_changes.outputs.tex_changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          convert -density 150 resume-en.pdf[0] -quality 90 example.jpg
      - name: Create Pull Request for screenshot update
        if: ${{ !startsWith(github.ref, 'refs/tags/') && github.ref == 'refs/heads/main' && steps.check_tex_changes.outputs.tex_changed == 'true' }}
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Update example.jpg screenshot"
          title: "Update example.jpg screenshot"
          body: "Automated update of the example screenshot from the latest resume-en.pdf"
          branch: "update-screenshot"
          delete-branch: true
      - name: Generate changelog for release
        if: startsWith(github.ref, 'refs/tags/')
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --oneline --no-decorate)
          else
            CHANGELOG=$(git log --oneline ${PREV_TAG}..HEAD --no-decorate)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Only upload artifacts if there is no tag
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v6
        with:
          name: resume
          path: resume-*.pdf
      - name: Upload all PDFs to release if there is a tag
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: resume-*.pdf
          body: ${{ steps.changelog.outputs.changelog }}